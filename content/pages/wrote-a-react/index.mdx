---
title: "èµ„æºæ¨è - 200è¡Œä»£ç å®ç°ç®€ç‰ˆreact"
date: "2021-02-01"
featured: false
category: "resource"
excerpt: ""
tag: ["iv"]
status: "publish"
type: "post"
cover: "./cover.png"
---

reactåœ¨å‰ç«¯å¼€å‘é¢†åŸŸå·²ç»è¶Šæ¥è¶ŠğŸ”¥äº†ï¼Œæˆ‘è‡ªå·±ä¹Ÿç»å¸¸åœ¨é¡¹ç›®ä¸­ä½¿ç”¨reactï¼Œä½†æ˜¯å´æ€»æ˜¯å¥½å¥‡reactçš„åº•å±‚å®ç°åŸç†ï¼Œå¤šæ¬¡å°è¯•é˜…è¯»reactæºä»£ç éƒ½æ— æ³•è¯»ä¸‹å»ï¼Œç¡®å®å¤ªéš¾äº†ã€‚å‰ä¸ä¹…åœ¨ç½‘ä¸Šçœ‹åˆ°å‡ ç¯‡ä»‹ç»å¦‚ä½•è‡ªå·±åŠ¨æ‰‹å®ç°reactçš„æ–‡ç« ï¼Œè¿™é‡ŒåŸºäºè¿™äº›èµ„æ–™ï¼Œå¹¶åŠ å…¥ä¸€äº›è‡ªå·±çš„æƒ³æ³•ï¼Œä»0å¼€å§‹ä»…ç”¨200è¡Œä»£ç å®ç°ä¸€ä¸ªç®€ç‰ˆreactï¼Œç›¸ä¿¡çœ‹å®Œåå¤§å®¶éƒ½ä¼šå¯¹reactçš„å†…éƒ¨å®ç°åŸç†æœ‰æ›´å¤šäº†è§£ã€‚ä½†æ˜¯åœ¨åŠ¨æ‰‹ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆæŒæ¡å‡ ä¸ªreactç›¸å…³çš„é‡è¦æ¦‚å¿µï¼Œæ¯”å¦‚ç»„ä»¶(ç±»)ä¸ç»„ä»¶å®ä¾‹çš„åŒºåˆ«ã€diffç®—æ³•ä»¥åŠç”Ÿå‘½å‘¨æœŸç­‰ï¼Œä¸‹é¢ä¾æ¬¡ä»‹ç»ä¸‹ï¼Œç†Ÿæ‚‰å®Œè¿™äº›æ¦‚å¿µæˆ‘ä»¬å†åŠ¨æ‰‹å®ç°ã€‚  

## 1 åŸºæœ¬æ¦‚å¿µï¼š

`Component(ç»„ä»¶)`ã€`instance(ç»„ä»¶å®ä¾‹)`ã€ `element`ã€`jsx`ã€`dom`  

é¦–å…ˆæˆ‘ä»¬éœ€è¦å¼„æ˜ç™½å‡ ä¸ªå®¹æ˜“æ··æ·†çš„æ¦‚å¿µï¼Œæœ€å¼€å§‹å­¦ä¹ reactçš„æ—¶å€™æˆ‘ä¹Ÿæœ‰äº›ç–‘æƒ‘ä»–ä»¬ä¹‹é—´æœ‰ä»€ä¹ˆä¸åŒï¼Œå‰å‡ å¤©è·Ÿä¸€ä¸ªæ–°åŒå­¦è®¨è®ºä¸€ä¸ªé—®é¢˜ï¼Œå‘ç°ä»–ç«Ÿç„¶ä¹Ÿåˆ†ä¸æ¸…ç»„ä»¶å’Œç»„ä»¶å®ä¾‹ï¼Œå› æ­¤å¾ˆæœ‰å¿…è¦å¼„æ˜ç™½è¿™å‡ ä¸ªæ¦‚å¿µçš„åŒºåˆ«äºè”ç³»ï¼Œæœ¬ç¯‡åé¢æˆ‘ä»¬å®ç°è¿™ä¸ªç®€ç‰ˆreactä¹Ÿæ˜¯åŸºäºè¿™äº›æ¦‚å¿µã€‚  

### Componentï¼ˆç»„ä»¶ï¼‰
Componentå°±æ˜¯æˆ‘ä»¬ç»å¸¸å®ç°çš„ç»„ä»¶ï¼Œå¯ä»¥æ˜¯ç±»ç»„ä»¶ï¼ˆ`class component`ï¼‰æˆ–è€…å‡½æ•°å¼ç»„ä»¶ï¼ˆ`functional component`ï¼‰ï¼Œè€Œç±»ç»„ä»¶åˆå¯ä»¥åˆ†ä¸ºæ™®é€šç±»ç»„ä»¶(`React.Component`)ä»¥åŠçº¯ç±»ç»„ä»¶ï¼ˆ`React.PureComponent`ï¼‰ï¼Œæ€»ä¹‹è¿™ä¸¤ç±»éƒ½å±äºç±»ç»„ä»¶ï¼Œåªä¸è¿‡`PureComponent`åŸºäº`shouldComponentUpdate`åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œè¿™é‡Œä¸å±•å¼€è¯´ã€‚å‡½æ•°å¼ç»„ä»¶åˆ™ç”¨æ¥ç®€åŒ–ä¸€äº›ç®€å•ç»„ä»¶çš„å®ç°ï¼Œç”¨èµ·æ¥å°±æ˜¯å†™ä¸€ä¸ªå‡½æ•°ï¼Œå…¥å‚æ˜¯ç»„ä»¶å±æ€§`props`ï¼Œå‡ºå‚ä¸ç±»ç»„ä»¶çš„`render`æ–¹æ³•è¿”å›å€¼ä¸€æ ·ï¼Œæ˜¯`react element`ï¼ˆæ³¨æ„è¿™é‡Œå·²ç»å‡ºç°äº†æ¥ä¸‹æ¥è¦ä»‹ç»çš„`element`å“¦ï¼‰ã€‚  

ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æŒ‰ä¸‰ç§æ–¹å¼å®ç°ä¸‹Welcomeç»„ä»¶ï¼š  

```jsx
// Component
class Welcome extends React.Component {
    render() {
        return <h1>Hello, {this.props.name}</h1>;
    }
}
// PureComponent
class Welcome extends React.PureComponent {
    render() {
        return <h1>Hello, {this.props.name}</h1>;
    }
}
// functional component
function Welcome(props) {
    return <h1>Hello, {props.name}</h1>;
}
```
### instanceï¼ˆç»„ä»¶å®ä¾‹ï¼‰  

ç†Ÿæ‚‰é¢å‘å¯¹è±¡ç¼–ç¨‹çš„äººè‚¯å®šçŸ¥é“ç±»å’Œå®ä¾‹çš„å…³ç³»ï¼Œè¿™é‡Œä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œç»„ä»¶å®ä¾‹å…¶å®å°±æ˜¯ä¸€ä¸ªç»„ä»¶ç±»å®ä¾‹åŒ–çš„ç»“æœï¼Œæ¦‚å¿µè™½ç„¶ç®€å•ï¼Œä½†æ˜¯åœ¨reactè¿™é‡Œå´å®¹æ˜“å¼„ä¸æ˜ç™½ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿå› ä¸ºå¤§å®¶åœ¨reactçš„ä½¿ç”¨è¿‡ç¨‹ä¸­å¹¶ä¸ä¼šè‡ªå·±å»å®ä¾‹åŒ–ä¸€ä¸ªç»„ä»¶å®ä¾‹ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®æ˜¯reactå†…éƒ¨å¸®æˆ‘ä»¬å®Œæˆçš„ï¼Œå› æ­¤æˆ‘ä»¬çœŸæ­£æ¥è§¦ç»„ä»¶å®ä¾‹çš„æœºä¼šå¹¶ä¸å¤šã€‚æˆ‘ä»¬æ›´å¤šæ¥è§¦åˆ°çš„æ˜¯ä¸‹é¢è¦ä»‹ç»çš„elementï¼Œå› ä¸ºæˆ‘ä»¬é€šå¸¸å†™çš„jsxå…¶å®å°±æ˜¯elementçš„ä¸€ç§è¡¨ç¤ºæ–¹å¼è€Œå·²(åé¢è¯¦ç»†ä»‹ç»)ã€‚è™½ç„¶ç»„ä»¶å®ä¾‹ç”¨çš„ä¸å¤šï¼Œä½†æ˜¯å¶å°”ä¹Ÿä¼šç”¨åˆ°ï¼Œå…¶å®å°±æ˜¯refã€‚refå¯ä»¥æŒ‡å‘ä¸€ä¸ªdomèŠ‚ç‚¹æˆ–è€…ä¸€ä¸ªç±»ç»„ä»¶(class component)çš„å®ä¾‹ï¼Œä½†æ˜¯ä¸èƒ½ç”¨äºå‡½æ•°å¼ç»„ä»¶ï¼Œå› ä¸ºå‡½æ•°å¼ç»„ä»¶ä¸èƒ½å®ä¾‹åŒ–ã€‚è¿™é‡Œç®€å•ä»‹ç»ä¸‹refï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“refå¯ä»¥æŒ‡å‘ä¸€ä¸ªç»„ä»¶å®ä¾‹å³å¯ï¼Œæ›´åŠ è¯¦ç»†çš„ä»‹ç»å¤§å®¶å¯ä»¥çœ‹reactå®˜æ–¹æ–‡æ¡£Refs and the DOMã€‚  

### element  

å‰é¢å·²ç»æåˆ°äº†elementï¼Œå³ç±»ç»„ä»¶çš„renderæ–¹æ³•ä»¥åŠå‡½æ•°å¼ç»„ä»¶çš„è¿”å›å€¼å‡ä¸ºelementã€‚é‚£ä¹ˆè¿™é‡Œçš„elementåˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªçº¯å¯¹è±¡ï¼ˆ`plain object`ï¼‰ï¼Œè€Œä¸”è¿™ä¸ªçº¯å¯¹è±¡åŒ…å«ä¸¤ä¸ªå±æ€§ï¼š`type:(string|ReactClass)`å’Œ`props:Object`ï¼Œæ³¨æ„`element`å¹¶ä¸æ˜¯ç»„ä»¶å®ä¾‹ï¼Œè€Œæ˜¯ä¸€ä¸ªçº¯å¯¹è±¡ã€‚è™½ç„¶`element`ä¸æ˜¯ç»„ä»¶å®ä¾‹ï¼Œä½†æ˜¯åˆè·Ÿç»„ä»¶å®ä¾‹æœ‰å…³ç³»ï¼Œ`element`æ˜¯å¯¹ç»„ä»¶å®ä¾‹æˆ–è€…`dom`èŠ‚ç‚¹çš„æè¿°ã€‚å¦‚æœtypeæ˜¯`string`ç±»å‹ï¼Œåˆ™è¡¨ç¤ºdomèŠ‚ç‚¹ï¼Œå¦‚æœtypeæ˜¯`function`æˆ–è€…`class`ç±»å‹ï¼Œåˆ™è¡¨ç¤ºç»„ä»¶å®ä¾‹ã€‚æ¯”å¦‚ä¸‹é¢ä¸¤ä¸ªelementåˆ†åˆ«æè¿°äº†ä¸€ä¸ªdomèŠ‚ç‚¹å’Œä¸€ä¸ªç»„ä»¶å®ä¾‹ï¼š

```jsx
// æè¿°domèŠ‚ç‚¹
{
  type: 'button',
  props: {
    className: 'button button-blue',
    children: {
      type: 'b',
      props: {
        children: 'OK!'
      }
    }
  }
}
function Button(props){
  // ...
}

// æè¿°ç»„ä»¶å®ä¾‹
{
  type: Button,
  props: {
    color: 'blue',
    children: 'OK!'
  }
}
```
### jsx  
åªè¦å¼„æ˜ç™½äº†elementï¼Œé‚£ä¹ˆjsxå°±ä¸éš¾ç†è§£äº†ï¼Œjsxåªæ˜¯æ¢äº†ä¸€ç§å†™æ³•ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ¥åˆ›å»º`element`è€Œå·²ï¼Œæƒ³æƒ³å¦‚æœæ²¡æœ‰jsxé‚£ä¹ˆæˆ‘ä»¬å¼€å‘æ•ˆç‡è‚¯å®šä¼šå¤§å¹…é™ä½ï¼Œè€Œä¸”ä»£ç è‚¯å®šéå¸¸ä¸åˆ©äºç»´æŠ¤ã€‚æ¯”å¦‚æˆ‘ä»¬çœ‹ä¸‹é¢è¿™ä¸ªjsxçš„ä¾‹å­ï¼š  

`const foo = <div id="foo">Hello!</div>;`

å…¶å®è¯´ç™½äº†å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªdomèŠ‚ç‚¹divï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹çš„å±æ€§é›†åˆæ˜¯`{id: 'foo'}`ï¼Œchildrenæ˜¯Hello!ï¼Œå°±è¿™ç‚¹ä¿¡æ¯é‡è€Œå·²ï¼Œå› æ­¤å®Œå…¨è·Ÿä¸‹é¢è¿™ç§çº¯å¯¹è±¡çš„è¡¨ç¤ºæ˜¯ç­‰ä»·çš„ï¼š

```jsx
{
  type: 'div',
  props: {
    id: 'foo',
    children: 'Hello!'
  }
}
```

é‚£ä¹ˆReactæ˜¯å¦‚ä½•å°†jsxè¯­æ³•è½¬æ¢ä¸ºçº¯å¯¹è±¡çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯åˆ©ç”¨Babelç¼–è¯‘ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬åªè¦åœ¨ä½¿ç”¨jsxçš„ä»£ç é‡ŒåŠ ä¸Šä¸ªç¼–è¯‘æŒ‡ç¤º(pragma)å³å¯ï¼Œå¯ä»¥å‚è€ƒè¿™é‡ŒBabelå¦‚ä½•ç¼–è¯‘jsxã€‚
æ¯”å¦‚æˆ‘ä»¬å°†ç¼–è¯‘æŒ‡ç¤ºè®¾ç½®ä¸ºæŒ‡å‘createElementå‡½æ•°ï¼š/** @jsx createElement */ï¼Œé‚£ä¹ˆå‰é¢é‚£æ®µjsxä»£ç å°±ä¼šç¼–è¯‘ä¸ºï¼š
```jsx
var foo = createElement('div', {id:"foo"}, 'Hello!');
```

å¯ä»¥çœ‹å‡ºï¼Œjsxçš„ç¼–è¯‘è¿‡ç¨‹å…¶å®å°±æ˜¯ä»<ã€>è¿™ç§æ ‡ç­¾å¼å†™æ³•åˆ°å‡½æ•°è°ƒç”¨å¼å†™æ³•çš„ä¸€ç§è½¬åŒ–è€Œå·²ã€‚æœ‰äº†è¿™ä¸ªå‰æï¼Œæˆ‘ä»¬åªéœ€è¦ç®€å•å®ç°ä¸‹createElementå‡½æ•°ä¸å°±å¯ä»¥æ„é€ å‡ºelementäº†å˜›ï¼Œæˆ‘ä»¬åé¢è‡ªå·±å®ç°ç®€ç‰ˆreactä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼š  

```jsx
function createElement(type, props, ...children) {
    props = Object.assign({}, props);
    props.children = [].concat(...children)
      .filter(child => child != null && child !== false)
      .map(child => child instanceof Object ? child : createTextElement(child));
    return {type, props};
}
```

### dom  
domæˆ‘ä»¬è¿™é‡Œä¹Ÿç®€å•ä»‹ç»ä¸‹ï¼Œä½œä¸ºä¸€ä¸ªå‰ç«¯ç ”å‘äººå‘˜ï¼Œæƒ³å¿…å¤§å®¶å¯¹è¿™ä¸ªæ¦‚å¿µåº”è¯¥å†ç†Ÿæ‚‰ä¸è¿‡äº†ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·åˆ›å»ºä¸€ä¸ªdomèŠ‚ç‚¹divï¼š

```jsx
const divDomNode = window.document.createElement('div');
```

å…¶å®æ‰€æœ‰domèŠ‚ç‚¹éƒ½æ˜¯HTMLElementç±»çš„å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯ä¸‹ï¼š

```jsx
window.document.createElement('div') instanceof window.HTMLElement;

// è¾“å‡º true
```

å…³äºHTMLElementAPIå¯ä»¥å‚è€ƒè¿™é‡Œï¼šHTMLElementä»‹ç»ã€‚å› æ­¤ï¼ŒdomèŠ‚ç‚¹æ˜¯HTMLElementç±»çš„å®ä¾‹ï¼›åŒæ ·çš„ï¼Œåœ¨reacté‡Œé¢ï¼Œç»„ä»¶å®ä¾‹æ˜¯ç»„ä»¶ç±»çš„å®ä¾‹ï¼Œè€Œelementåˆæ˜¯å¯¹ç»„ä»¶å®ä¾‹å’ŒdomèŠ‚ç‚¹çš„æè¿°ï¼Œç°åœ¨è¿™äº›æ¦‚å¿µä¹‹é—´çš„å…³ç³»å¤§å®¶åº”è¯¥éƒ½æ¸…æ¥šäº†å§ã€‚ä»‹ç»å®Œäº†è¿™å‡ ä¸ªåŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬ç”»ä¸ªå›¾æ¥æè¿°ä¸‹è¿™å‡ ä¸ªæ¦‚å¿µä¹‹é—´çš„å…³ç³»ï¼š
![](./1.png)

## 2 è™šæ‹Ÿdomä¸diffç®—æ³•

ç›¸ä¿¡ä½¿ç”¨è¿‡reactçš„åŒå­¦éƒ½å¤šå°‘äº†è§£è¿‡è¿™ä¸¤ä¸ªæ¦‚å¿µï¼šè™šæ‹Ÿdomä»¥åŠdiffç®—æ³•ã€‚è¿™é‡Œçš„è™šæ‹Ÿdomå…¶å®å°±æ˜¯å‰é¢ä»‹ç»çš„elementï¼Œä¸ºä»€ä¹ˆè¯´æ˜¯è™šæ‹Ÿdomå‘¢ï¼Œå‰é¢å’±ä»¬å·²ç»ä»‹ç»è¿‡äº†ï¼Œelementåªæ˜¯domèŠ‚ç‚¹æˆ–è€…ç»„ä»¶å®ä¾‹çš„ä¸€ç§çº¯å¯¹è±¡æè¿°è€Œå·²ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„domèŠ‚ç‚¹ï¼Œå› æ­¤æ˜¯è™šæ‹Ÿdomã€‚reactç»™æˆ‘ä»¬æä¾›äº†å£°æ˜å¼çš„ç»„ä»¶å†™æ³•ï¼Œå½“ç»„ä»¶çš„propsæˆ–è€…stateå˜åŒ–æ—¶ç»„ä»¶è‡ªåŠ¨æ›´æ–°ã€‚æ•´ä¸ªé¡µé¢å…¶å®å¯ä»¥å¯¹åº”åˆ°ä¸€æ£µdomèŠ‚ç‚¹æ ‘ï¼Œæ¯æ¬¡ç»„ä»¶propsæˆ–è€…stateå˜æ›´é¦–å…ˆä¼šåæ˜ åˆ°è™šæ‹Ÿdomæ ‘ï¼Œç„¶åæœ€ç»ˆååº”åˆ°é¡µé¢domèŠ‚ç‚¹æ ‘çš„æ¸²æŸ“ã€‚
é‚£ä¹ˆè™šæ‹Ÿdomè·Ÿdiffç®—æ³•åˆæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿä¹‹æ‰€ä»¥æœ‰diffç®—æ³•å…¶å®æ˜¯ä¸ºäº†æå‡æ¸²æŸ“æ•ˆç‡ï¼Œè¯•æƒ³ä¸‹ï¼Œå¦‚æœæ¯æ¬¡ç»„ä»¶çš„stateæˆ–è€…propså˜åŒ–åéƒ½æŠŠæ‰€æœ‰ç›¸å…³domèŠ‚ç‚¹åˆ æ‰å†é‡æ–°åˆ›å»ºï¼Œé‚£æ•ˆç‡è‚¯å®šéå¸¸ä½ï¼Œæ‰€ä»¥åœ¨reactå†…éƒ¨å­˜åœ¨ä¸¤æ£µè™šæ‹Ÿdomæ ‘ï¼Œåˆ†åˆ«è¡¨ç¤ºç°çŠ¶ä»¥åŠä¸‹ä¸€ä¸ªçŠ¶æ€ï¼ŒsetStateè°ƒç”¨åå°±ä¼šè§¦å‘diffç®—æ³•çš„æ‰§è¡Œï¼Œè€Œå¥½çš„diffç®—æ³•è‚¯å®šæ˜¯å°½å¯èƒ½å¤ç”¨å·²æœ‰çš„domèŠ‚ç‚¹ï¼Œé¿å…é‡æ–°åˆ›å»ºçš„å¼€é”€ã€‚æˆ‘ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºè™šæ‹Ÿdomå’Œdiffç®—æ³•çš„å…³ç³»ï¼š

![](./2.png)

reactç»„ä»¶æœ€åˆæ¸²æŸ“åˆ°é¡µé¢åå…ˆç”Ÿæˆç¬¬1å¸§è™šæ‹Ÿdomï¼Œè¿™æ—¶currentæŒ‡é’ˆæŒ‡å‘è¯¥ç¬¬ä¸€å¸§ã€‚setStateè°ƒç”¨åä¼šç”Ÿæˆç¬¬2å¸§è™šæ‹Ÿdomï¼Œè¿™æ—¶nextæŒ‡é’ˆæŒ‡å‘ç¬¬äºŒå¸§ï¼Œæ¥ä¸‹æ¥diffç®—æ³•é€šè¿‡æ¯”è¾ƒç¬¬2å¸§å’Œç¬¬1å¸§çš„å¼‚åŒæ¥å°†æ›´æ–°åº”ç”¨åˆ°çœŸæ­£çš„domæ ‘ä»¥å®Œæˆé¡µé¢æ›´æ–°ã€‚
è¿™é‡Œå†æ¬¡å¼ºè°ƒä¸€ä¸‹setStateåå…·ä½“æ€ä¹ˆç”Ÿæˆè™šæ‹Ÿdomï¼Œå› ä¸ºè¿™ç‚¹å¾ˆé‡è¦ï¼Œè€Œä¸”å®¹æ˜“å¿½ç•¥ã€‚å‰é¢åˆšåˆšå·²ç»ä»‹ç»è¿‡ä»€ä¹ˆæ˜¯è™šæ‹Ÿdomäº†ï¼Œå°±æ˜¯elementæ ‘è€Œå·²ã€‚é‚£elementæ ‘æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯renderæ–¹æ³•è¿”å›çš„å˜›ï¼Œä¸‹é¢çš„æµç¨‹å›¾å†åŠ æ·±ä¸‹å°è±¡ï¼š

![](./3.png)

å…¶å®reactå®˜æ–¹å¯¹diffç®—æ³•æœ‰å¦å¤–ä¸€ä¸ªç§°å‘¼ï¼Œå¤§å®¶è‚¯å®šä¼šåœ¨reactç›¸å…³èµ„æ–™ä¸­çœ‹åˆ°ï¼Œå«Reconciliationï¼Œæˆ‘ä¸ªäººè®¤ä¸ºè¿™ä¸ªè¯æœ‰ç‚¹æ™¦æ¶©éš¾æ‡‚ï¼Œä¸è¿‡åæ¥åˆé‡æ–°ç¿»çœ‹äº†ä¸‹è¯å…¸ï¼Œå‘ç°è·Ÿdiffç®—æ³•ä¸€ä¸ªæ„æ€ï¼š
![](./4.png)

å¯ä»¥çœ‹åˆ°reconcileæœ‰æ¶ˆé™¤åˆ†æ­§ã€æ ¸å¯¹çš„æ„æ€ï¼Œåœ¨reactè¯­å¢ƒä¸‹å°±æ˜¯å¯¹æ¯”è™šæ‹Ÿdomå¼‚åŒçš„æ„æ€ï¼Œå…¶å®å°±æ˜¯è¯´çš„diffç®—æ³•ã€‚è¿™é‡Œå¼ºè°ƒä¸‹ï¼Œæˆ‘ä»¬åé¢å®ç°éƒ¨å®ç°reconcileå‡½æ•°ï¼Œå°±æ˜¯å®ç°diffç®—æ³•ã€‚

## 3 ç”Ÿå‘½å‘¨æœŸä¸diffç®—æ³•

ç”Ÿå‘½å‘¨æœŸä¸diffç®—æ³•åˆæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬ä»¥componentDidMountã€componentWillUnmountã€ComponentWillUpdateä»¥åŠcomponentDidUpdateä¸ºä¾‹è¯´æ˜ä¸‹äºŒè€…çš„å…³ç³»ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒsetStateè°ƒç”¨åä¼šæ¥ç€è°ƒç”¨renderç”Ÿæˆæ–°çš„è™šæ‹Ÿdomæ ‘ï¼Œè€Œè¿™ä¸ªè™šæ‹Ÿdomæ ‘ä¸ä¸Šä¸€å¸§å¯èƒ½ä¼šäº§ç”Ÿå¦‚ä¸‹åŒºåˆ«ï¼š

æ–°å¢äº†æŸä¸ªç»„ä»¶ï¼›
åˆ é™¤äº†æŸä¸ªç»„ä»¶ï¼›
æ›´æ–°äº†æŸä¸ªç»„ä»¶çš„éƒ¨åˆ†å±æ€§ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬åœ¨å®ç°diffç®—æ³•çš„è¿‡ç¨‹ä¼šåœ¨ç›¸åº”çš„æ—¶é—´èŠ‚ç‚¹è°ƒç”¨è¿™äº›ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚
è¿™é‡Œéœ€è¦é‡ç‚¹è¯´æ˜ä¸‹å‰é¢æåˆ°çš„ç¬¬1å¸§ï¼Œæˆ‘ä»¬çŸ¥é“æ¯ä¸ªreactåº”ç”¨çš„å…¥å£éƒ½æ˜¯ï¼š
https://juejin.cn/post/6844903733998911501
```jsx
ReactDOM.render(
    <h1>Hello, world!</h1>,
    document.getElementById('root')
);
```
`ReactDom.render`ä¹Ÿä¼šç”Ÿæˆä¸€æ£µè™šæ‹Ÿdomæ ‘ï¼Œä½†æ˜¯è¿™æ£µè™šæ‹Ÿdomæ ‘æ˜¯å¼€å¤©è¾Ÿåœ°ç”Ÿæˆçš„ç¬¬ä¸€å¸§ï¼Œæ²¡æœ‰å‰ä¸€å¸§ç”¨æ¥åšdiffï¼Œå› æ­¤è¿™æ£µè™šæ‹Ÿdomæ ‘å¯¹åº”çš„æ‰€æœ‰ç»„ä»¶éƒ½åªä¼šè°ƒç”¨æŒ‚è½½æœŸçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œæ¯”å¦‚`componentDidMount`ã€`componentWillUnmount`ã€‚

## 4 å®ç°
æŒæ¡äº†å‰é¢ä»‹ç»çš„è¿™äº›æ¦‚å¿µï¼Œå®ç°ä¸€ä¸ªç®€ç‰ˆreactä¹Ÿå°±ä¸éš¾äº†ã€‚è¿™é‡Œéœ€è¦è¯´æ˜ä¸‹ï¼Œæœ¬èŠ‚å®ç°éƒ¨åˆ†æ˜¯åŸºäºè¿™ç¯‡åšå®¢çš„å®ç°Didact: a DIY guide to build your own Reactã€‚
ç°åœ¨é¦–å…ˆçœ‹ä¸€ä¸‹æˆ‘ä»¬è¦å®ç°å“ªäº›APIï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šä»¥å¦‚ä¸‹æ–¹å¼ä½¿ç”¨ï¼š
```jsx
// å£°æ˜ç¼–è¯‘æŒ‡ç¤º
/** @jsx DiyReact.createElement */

// å¯¼å…¥æˆ‘ä»¬ä¸‹é¢è¦å®ç°çš„API
const DiyReact = importFromBelow();

// ä¸šåŠ¡ä»£ç 
const randomLikes = () => Math.ceil(Math.random() * 100);
const stories = [
  {name: "React", url: "https://reactjs.org/", likes: randomLikes()},
  {name: "Node", url: "https://nodejs.org/en/", likes: randomLikes()},
  {name: "Webpack", url: "https://webpack.js.org/", likes: randomLikes()}
];

const ItemRender = props => {
  const {name, url} = props;
  return (
    <a href={url}>{name}</a>
  );
};

class App extends DiyReact.Component {
    render() {
        return (
            <div>
                <h1>DiyReact Stories</h1>
                <ul>
                    {this.props.stories.map(story => {
                        return <Story name={story.name} url={story.url} />;
                    })}
                </ul>
            </div>
        );
    }
    
    componentWillMount() {
        console.log('execute componentWillMount');
    }
    
    componentDidMount() {
        console.log('execute componentDidMount');
    }
    
    componentWillUnmount() {
        console.log('execute componentWillUnmount');
    }
}

class Story extends DiyReact.Component {
    constructor(props) {
        super(props);
        this.state = {likes: Math.ceil(Math.random() * 100)};
    }
    like() {
        this.setState({
            likes: this.state.likes + 1
        });
    }
    render() {
        const {name, url} = this.props;
        const {likes} = this.state;
        const likesElement = <span />;
        return (
            <li>
                <button onClick={e => this.like()}>{likes}<b>â¤ï¸</b></button>
                <ItemRender {...itemRenderProps} />
            </li>
        );
    }
    
    // shouldcomponentUpdate() {
    //   return true;
    // }
    
    componentWillUpdate() {
        console.log('execute componentWillUpdate');
    }
    
    componentDidUpdate() {
        console.log('execute componentDidUpdate');
    }
}

// å°†ç»„ä»¶æ¸²æŸ“åˆ°æ ¹domèŠ‚ç‚¹

DiyReact.render(<App stories={stories} />, document.getElementById("root"));
```

æˆ‘ä»¬åœ¨è¿™æ®µä¸šåŠ¡ä»£ç é‡Œé¢ä½¿ç”¨äº†renderã€createElementä»¥åŠComponentä¸‰ä¸ªAPIï¼Œå› æ­¤åé¢çš„ä»»åŠ¡å°±æ˜¯å®ç°è¿™ä¸‰ä¸ªAPIå¹¶åŒ…è£…åˆ°ä¸€ä¸ªå‡½æ•°importFromBelowå†…å³å¯ã€‚

#### 4.1 å®ç°createElement
createElementå‡½æ•°çš„åŠŸèƒ½è·Ÿjsxæ˜¯ç´§å¯†ç›¸å…³çš„ï¼Œå‰é¢ä»‹ç»jsxçš„éƒ¨åˆ†å·²ç»ä»‹ç»è¿‡äº†ï¼Œå…¶å®å°±æ˜¯æŠŠç±»ä¼¼htmlçš„æ ‡ç­¾å¼å†™æ³•è½¬åŒ–ä¸ºçº¯å¯¹è±¡elementï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š

```jsx
function createElement(type, props, ...children) {
    props = Object.assign({}, props);
    props.children = [].concat(...children)
        .filter(child => child != null && child !== false)
        .map(child => child instanceof Object ? child : createTextElement(child));
    return {type, props};
}
```

#### 4.2 å®ç°render  
æ³¨æ„è¿™ä¸ªrenderç›¸å½“äºReactDOM.renderï¼Œä¸æ˜¯ç»„ä»¶çš„renderæ–¹æ³•ï¼Œç»„ä»¶çš„renderæ–¹æ³•åœ¨åé¢Componentå®ç°éƒ¨åˆ†ã€‚

```jsx
// rootInstanceç”¨æ¥ç¼“å­˜ä¸€å¸§è™šæ‹Ÿdom
let rootInstance = null;
function render(element, parentDom) {
    // prevInstanceæŒ‡å‘å‰ä¸€å¸§
    const prevInstance = rootInstance;
    // elementå‚æ•°æŒ‡å‘æ–°ç”Ÿæˆçš„è™šæ‹Ÿdomæ ‘
    const nextInstance = reconcile(parentDom, prevInstance, element);
    // è°ƒç”¨å®Œreconcileç®—æ³•(å³diffç®—æ³•)åå°†rooInstanceæŒ‡å‘æœ€æ–°ä¸€å¸§
    rootInstance = nextInstance;
}
```

renderå‡½æ•°å®ç°å¾ˆç®€å•ï¼Œåªæ˜¯è¿›è¡Œäº†ä¸¤å¸§è™šæ‹Ÿdomçš„å¯¹æ¯”(reconcile)ï¼Œç„¶åå°†rootInstanceæŒ‡å‘æ–°çš„è™šæ‹Ÿdomã€‚ç»†å¿ƒç‚¹ä¼šå‘ç°ï¼Œæ–°çš„è™šæ‹Ÿdomä¸ºelementï¼Œå³æœ€å¼€å§‹ä»‹ç»çš„elementï¼Œè€Œreconcileåçš„è™šæ‹Ÿdomæ˜¯instanceï¼Œä¸è¿‡è¿™ä¸ªinstanceå¹¶ä¸æ˜¯ç»„ä»¶å®ä¾‹ï¼Œè¿™ç‚¹çœ‹åé¢instantiateçš„å®ç°ã€‚æ€»ä¹‹renderæ–¹æ³•å…¶å®å°±æ˜¯è°ƒç”¨äº†reconcileæ–¹æ³•è¿›è¡Œäº†ä¸¤å¸§è™šæ‹Ÿdomçš„å¯¹æ¯”è€Œå·²ã€‚

#### 4.3 å®ç°instantiate  

é‚£ä¹ˆå‰é¢çš„instanceåˆ°åº•è·Ÿelementæœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿå…¶å®instanceæŒ‡ç¤ºç®€å•çš„æ˜¯æŠŠelementé‡æ–°åŒ…äº†ä¸€å±‚ï¼Œå¹¶æŠŠå¯¹åº”çš„domä¹Ÿç»™åŒ…äº†è¿›æ¥ï¼Œè¿™ä¹Ÿä¸éš¾ç†è§£ï¼Œæ¯•ç«Ÿæˆ‘ä»¬è°ƒç”¨reconcileè¿›è¡Œdiffæ¯”è¾ƒçš„æ—¶å€™éœ€è¦æŠŠè·Ÿæ–°åº”ç”¨åˆ°çœŸå®çš„domä¸Šï¼Œå› æ­¤éœ€è¦è·Ÿdomå…³è”èµ·æ¥ï¼Œä¸‹é¢å®ç°çš„instantiateå‡½æ•°å°±å¹²è¿™ä¸ªäº‹çš„ã€‚æ³¨æ„ç”±äºelementåŒ…æ‹¬domç±»å‹å’ŒComponentç±»å‹(ç”±typeå­—æ®µåˆ¤æ–­ï¼Œä¸æ˜ç™½çš„è¯å¯ä»¥å›è¿‡å¤´çœ‹ä¸€ä¸‹ç¬¬ä¸€èŠ‚çš„elementç›¸å…³ä»‹ç»)ï¼Œå› æ­¤éœ€è¦åˆ†æƒ…å†µå¤„ç†ï¼š
domç±»å‹çš„element.typeä¸ºstringç±»å‹ï¼Œå¯¹åº”çš„instanceç»“æ„ä¸º{element, dom, childInstances}ã€‚
Componentç±»å‹çš„element.typeä¸ºReactClassç±»å‹ï¼Œå¯¹åº”çš„instanceç»“æ„ä¸º{dom, element, childInstance, publicInstance}ï¼Œæ³¨æ„è¿™é‡Œçš„publicInstanceå°±æ˜¯å‰é¢ä»‹ç»çš„ç»„ä»¶å®ä¾‹ã€‚

```jsx
function instantiate(element) {
    const {type, props = {}} = element;
    const isDomElement = typeof type === 'string';
    
    if (isDomElement) {
        // åˆ›å»ºdom
        const isTextElement = type === TEXT_ELEMENT;
        const dom = isTextElement ? document.createTextNode('') : document.createElement(type);
        
        // è®¾ç½®domçš„äº‹ä»¶ã€æ•°æ®å±æ€§
        updateDomProperties(dom, [], element.props);
        const children = props.children || [];
        const childInstances = children.map(instantiate);
        const childDoms = childInstances.map(childInstance => childInstance.dom);
        childDoms.forEach(childDom => dom.appendChild(childDom));
        const instance = {element, dom, childInstances};
        return instance;
    } else {
        const instance = {};
        const publicInstance = createPublicInstance(element, instance);
        const childElement = publicInstance.render();
        const childInstance = instantiate(childElement);
        Object.assign(instance, {dom: childInstance.dom, element, childInstance, publicInstance});
        return instance;
    }
}
```
éœ€è¦æ³¨æ„ï¼Œç”±äºdomèŠ‚ç‚¹å’Œç»„ä»¶å®ä¾‹éƒ½å¯èƒ½æœ‰å­©å­èŠ‚ç‚¹ï¼Œå› æ­¤instantiateå‡½æ•°ä¸­æœ‰é€’å½’å®ä¾‹åŒ–çš„é€»è¾‘ã€‚

#### 4.4 åŒºåˆ†ç±»ç»„ä»¶ä¸å‡½æ•°å¼ç»„ä»¶

å‰é¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œç»„ä»¶åŒ…æ‹¬ç±»ç»„ä»¶ï¼ˆ`class component`ï¼‰ä¸å‡½æ•°å¼ç»„ä»¶ï¼ˆ`functional component`ï¼‰ã€‚æˆ‘åœ¨å¹³æ—¶çš„ä¸šåŠ¡ä¸­ç»å¸¸ç”¨åˆ°è¿™ä¸¤ç±»ç»„ä»¶ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶ä»…ç”¨æ¥æ¸²æŸ“ï¼Œæˆ‘ä¸€èˆ¬ä¼šä½¿ç”¨å‡½æ•°å¼ç»„ä»¶ï¼Œæ¯•ç«Ÿä»£ç é€»è¾‘ç®€å•æ¸…æ™°æ˜“æ‡‚ã€‚é‚£ä¹ˆReactå†…éƒ¨æ˜¯å¦‚ä½•åŒºåˆ†å‡ºæ¥è¿™ä¸¤ç§ç»„ä»¶çš„å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜è¯´ç®€å•ä¹Ÿç®€å•ï¼Œè¯´å¤æ‚ä¹Ÿå¤æ‚ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œæ˜¯å› ä¸ºReactå†…éƒ¨å®ç°æ–¹å¼ç¡®å®æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯è¿™ç§ç®€å•çš„å®ç°æ–¹å¼å´æ˜¯ç»è¿‡å„ç§è€ƒé‡åç¡®å®šä¸‹æ¥çš„å®ç°æ–¹å¼ã€‚è›‹æ€»(Dan)æœ‰ä¸€ç¯‡æ–‡ç« è¯¦ç»†åˆ†æäº†ä¸‹Reactå†…éƒ¨å¦‚ä½•åŒºåˆ†äºŒè€…ï¼Œå¼ºçƒˆæ¨èå¤§å®¶é˜…è¯»ï¼Œè¿™é‡Œæˆ‘ç›´æ¥æ‹¿è¿‡æ¥ç”¨ï¼Œæ–‡ç« é“¾æ¥è§è¿™é‡ŒHow Does React Tell a Class from a Function?ã€‚å…¶å®å¾ˆç®€ç­”ï¼Œæˆ‘ä»¬å®ç°ç±»ç»„ä»¶è‚¯å®šéœ€è¦ç»§æ‰¿è‡ªç±»`React.Component`ï¼Œå› æ­¤é¦–å…ˆç»™`React.Component`æ‰“ä¸ªæ ‡è®°ï¼Œç„¶ååœ¨å®ä¾‹åŒ–ç»„ä»¶æ—¶åˆ¤æ–­element.typeçš„åŸå‹é“¾ä¸Šæ˜¯å¦æœ‰è¯¥æ ‡è®°å³å¯ã€‚

```jsx
// æ‰“æ ‡è®°
Component.prototype.isReactComponent = {};

// åŒºåˆ†ç»„ä»¶ç±»å‹
const type = element.type;
const isDomElement = typeof type === 'string';
const isClassElement = !!(type.prototype && type.prototype.isReactComponent);
```

è¿™é‡Œæˆ‘ä»¬å‡çº§ä¸‹å‰é¢çš„å®ä¾‹åŒ–å‡½æ•°instantiateä»¥åŒºåˆ†å‡ºå‡½æ•°å¼ç»„ä»¶ä¸ç±»ç»„ä»¶ï¼š

```jsx
function instantiate(element) {
    const {type, props = {}} = element;
    const isDomElement = typeof type === 'string';
    const isClassElement = !!(type.prototype && type.prototype.isReactComponent);
    if (isDomElement) {
      // åˆ›å»ºdom
      const isTextElement = type === TEXT_ELEMENT;
      const dom = isTextElement ? document.createTextNode('') : document.createElement(type);
      
      // è®¾ç½®domçš„äº‹ä»¶ã€æ•°æ®å±æ€§
      updateDomProperties(dom, [], element.props);
      const children = props.children || [];
      const childInstances = children.map(instantiate);
      const childDoms = childInstances.map(childInstance => childInstance.dom);
      childDoms.forEach(childDom => dom.appendChild(childDom));
      const instance = {element, dom, childInstances};
      return instance;
    } else if (isClassElement) {
      const instance = {};
      const publicInstance = createPublicInstance(element, instance);
      const childElement = publicInstance.render();
      const childInstance = instantiate(childElement);
      Object.assign(instance, {dom: childInstance.dom, element, childInstance, publicInstance});
      return instance;
    } else {
      const childElement = type(element.props);
      const childInstance = instantiate(childElement);
      const instance = {
        dom: childInstance.dom,
        element,
        childInstance,
        fn: type
      };
      return instance;
    }
  }
 ```

å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ˜¯å‡½æ•°å¼ç»„ä»¶ï¼Œæˆ‘ä»¬æ²¡æœ‰å®ä¾‹åŒ–è¯¥ç»„ä»¶ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨äº†è¯¥å‡½æ•°è·å–è™šæ‹Ÿdomã€‚

#### 4.5 å®ç°reconcile(diffç®—æ³•)  
é‡ç‚¹æ¥äº†ï¼Œreconcileæ˜¯reactçš„æ ¸å¿ƒï¼Œæ˜¾ç„¶å¦‚ä½•å°†æ–°è®¾ç½®çš„stateå¿«é€Ÿçš„æ¸²æŸ“å‡ºæ¥éå¸¸é‡è¦ï¼Œå› æ­¤reactä¼šå°½é‡å¤ç”¨å·²æœ‰èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½åŠ¨æ€åˆ›å»ºæ‰€æœ‰ç›¸å…³èŠ‚ç‚¹ã€‚ä½†æ˜¯reactå¼ºå¤§çš„åœ°æ–¹è¿˜ä¸ä»…é™äºæ­¤ï¼Œreact16å°†reconcileç®—æ³•ç”±ä¹‹å‰çš„stackæ¶æ„å‡çº§æˆäº†fiberæ¶æ„ï¼Œæ›´è¿‘ä¸€æ­¥åšçš„æ€§èƒ½ä¼˜åŒ–ã€‚fiberç›¸å…³çš„å†…å®¹ä¸‹ä¸€èŠ‚å†ä»‹ç»ï¼Œè¿™é‡Œä¸ºäº†ç®€å•æ˜“æ‡‚ï¼Œä»ç„¶ä½¿ç”¨ç±»ä¼¼stackæ¶æ„çš„ç®—æ³•æ¥å®ç°ï¼Œå¯¹äºfiberç°åœ¨åªéœ€è¦çŸ¥é“å…¶è°ƒåº¦åŸç†å³å¯ï¼Œå½“ç„¶åé¢æœ‰æ—¶é—´å¯ä»¥å†å®ç°ä¸€ç‰ˆåŸºäºfiberæ¶æ„çš„ã€‚
é¦–å…ˆçœ‹ä¸€ä¸‹æ•´ä¸ªreconcileç®—æ³•çš„å¤„ç†æµç¨‹ï¼š
![](./5.png)
å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®ä¸åŒçš„æƒ…å†µåšä¸åŒçš„å¤„ç†ï¼š

å¦‚æœæ˜¯æ–°å¢instanceï¼Œé‚£ä¹ˆéœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªinstanceå¹¶ä¸”appendChildï¼›
å¦‚æœæ˜¯ä¸æ˜¯æ–°å¢instanceï¼Œè€Œæ˜¯åˆ é™¤instanceï¼Œé‚£ä¹ˆéœ€è¦removeChildï¼›
å¦‚æœæ—¢ä¸æ˜¯æ–°å¢ä¹Ÿä¸æ˜¯åˆ é™¤instanceï¼Œé‚£ä¹ˆéœ€è¦çœ‹instanceçš„typeæ˜¯å¦å˜åŒ–ï¼Œå¦‚æœæœ‰å˜åŒ–ï¼Œé‚£èŠ‚ç‚¹å°±æ— æ³•å¤ç”¨äº†ï¼Œä¹Ÿéœ€è¦å®ä¾‹åŒ–instanceï¼Œç„¶åreplaceChildï¼›
å¦‚æœtypeæ²¡å˜åŒ–å°±å¯ä»¥å¤ç”¨å·²æœ‰èŠ‚ç‚¹äº†ï¼Œè¿™ç§æƒ…å†µä¸‹è¦åˆ¤æ–­æ˜¯åŸç”ŸdomèŠ‚ç‚¹è¿˜æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰å®ç°çš„reactèŠ‚ç‚¹ï¼Œä¸¤ç§æƒ…å†µä¸‹å¤„ç†æ–¹å¼ä¸åŒã€‚

å¤§æµç¨‹äº†è§£åï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å¯¹çš„æ—¶é—´ç‚¹æ‰§è¡Œç”Ÿå‘½å‘¨æœŸå‡½æ•°å³å¯ï¼Œä¸‹é¢çœ‹å…·ä½“å®ç°ï¼š

```jsx
function reconcile(parentDom, instance, element) {
    if (instance === null) {
        const newInstance = instantiate(element);
        // componentWillMount
        newInstance.publicInstance
            && newInstance.publicInstance.componentWillMount
            && newInstance.publicInstance.componentWillMount();
        parentDom.appendChild(newInstance.dom);
        // componentDidMount
        newInstance.publicInstance
            && newInstance.publicInstance.componentDidMount
            && newInstance.publicInstance.componentDidMount();
        return newInstance;
    } else if (element === null) {
        // componentWillUnmount
        instance.publicInstance
            && instance.publicInstance.componentWillUnmount
            && instance.publicInstance.componentWillUnmount();
        parentDom.removeChild(instance.dom);
        return null;
    } else if (instance.element.type !== element.type) {
        const newInstance = instantiate(element);
        // componentDidMount
        newInstance.publicInstance
            && newInstance.publicInstance.componentDidMount
            && newInstance.publicInstance.componentDidMount();
        parentDom.replaceChild(newInstance.dom, instance.dom);
        return newInstance;
    } else if (typeof element.type === 'string') {
        updateDomProperties(instance.dom, instance.element.props, element.props);
        instance.childInstances = reconcileChildren(instance, element);
        instance.element = element;
        return instance;
    } else {
        if (instance.publicInstance
            && instance.publicInstance.shouldcomponentUpdate) {
            if (!instance.publicInstance.shouldcomponentUpdate()) {
                return;
            }
        }
        // componentWillUpdate
        instance.publicInstance
            && instance.publicInstance.componentWillUpdate
            && instance.publicInstance.componentWillUpdate();
        instance.publicInstance.props = element.props;
        let newChildElement;
        if (instance.publicInstance) { // ç±»ç»„ä»¶
            instance.publicInstance.props = element.props;
            newChildElement = instance.publicInstance.render();
        } else { // å‡½æ•°å¼ç»„ä»¶
            newChildElement = instance.fn(element.props);
        }
        const oldChildInstance = instance.childInstance;
        const newChildInstance = reconcile(parentDom, oldChildInstance, newChildElement);
        // componentDidUpdate
        instance.publicInstance
            && instance.publicInstance.componentDidUpdate
            && instance.publicInstance.componentDidUpdate();
        instance.dom = newChildInstance.dom;
        instance.childInstance = newChildInstance;
        instance.element = element;
        return instance;
    }
}

function reconcileChildren(instance, element) {
    const {dom, childInstances} = instance;
    const newChildElements = element.props.children || [];
    const count = Math.max(childInstances.length, newChildElements.length);
    const newChildInstances = [];
    for (let i = 0; i < count; i++) {
        newChildInstances[i] = reconcile(dom, childInstances[i], newChildElements[i]);
    }
    return newChildInstances.filter(instance => instance !== null);
}
```
çœ‹å®Œreconcileç®—æ³•åè‚¯å®šæœ‰äººä¼šå¥½å¥‡ï¼Œä¸ºä»€ä¹ˆè¿™ç§ç®—æ³•å«åšstackç®—æ³•ï¼Œè¿™é‡Œç®€å•è§£é‡Šä¸€ä¸‹ã€‚ä»å‰é¢çš„å®ç°å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡ç»„ä»¶çš„stateæ›´æ–°éƒ½ä¼šè§¦å‘reconcileçš„æ‰§è¡Œï¼Œè€Œreconcileçš„æ‰§è¡Œä¹Ÿæ˜¯ä¸€ä¸ªé€’å½’è¿‡ç¨‹ï¼Œè€Œä¸”ä¸€å¼€å§‹ç›´åˆ°é€’å½’æ‰§è¡Œå®Œæ‰€æœ‰èŠ‚ç‚¹æ‰åœæ­¢ï¼Œå› æ­¤ç§°ä¸ºstackç®—æ³•ã€‚ç”±äºæ˜¯ä¸ªé€’å½’è¿‡ç¨‹ï¼Œå› æ­¤è¯¥diffç®—æ³•ä¸€æ—¦å¼€å§‹å°±å¿…é¡»æ‰§è¡Œå®Œï¼Œå› æ­¤å¯èƒ½ä¼šé˜»å¡çº¿ç¨‹ï¼Œåˆç”±äºjsæ˜¯å•çº¿ç¨‹çš„ï¼Œå› æ­¤è¿™æ—¶å°±å¯èƒ½ä¼šå½±å“ç”¨æˆ·çš„è¾“å…¥æˆ–è€…uiçš„æ¸²æŸ“å¸§é¢‘ï¼Œé™ä½ç”¨æˆ·ä½“éªŒã€‚ä¸è¿‡react16ä¸­å‡çº§ä¸ºäº†fiberæ¶æ„ï¼Œè¿™ä¸€é—®é¢˜å¾—åˆ°äº†è§£å†³ã€‚

#### 4.6 æ•´ä½“ä»£ç 

æŠŠå‰é¢å®ç°çš„æ‰€æœ‰è¿™äº›ä»£ç ç»„åˆèµ·æ¥å°±æ˜¯å®Œæ•´çš„ç®€ç‰ˆreactï¼Œä¸åˆ°200è¡Œä»£ç ï¼Œso easyï½ï¼å®Œæ•´ä»£ç è§DiyReactã€‚

### 5 fiberæ¶æ„

react16å‡çº§äº†reconcileç®—æ³•æ¶æ„ï¼Œä»stackå‡çº§ä¸ºfiberæ¶æ„ï¼Œå‰é¢æˆ‘ä»¬å·²ç»æåˆ°è¿‡stackæ¶æ„çš„ç¼ºç‚¹ï¼Œé‚£å°±æ˜¯ä½¿ç”¨é€’å½’å®ç°ï¼Œä¸€æ—¦å¼€å§‹å°±æ— æ³•æš‚åœï¼Œåªèƒ½ä¸€å£æ°”æ‰§è¡Œå®Œæ¯•ï¼Œç”±äºjsæ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™å°±æœ‰å¯èƒ½é˜»å¡ç”¨æˆ·è¾“å…¥æˆ–è€…uiæ¸²æŸ“ï¼Œä¼šé™ä½ç”¨æˆ·ä½“éªŒã€‚
è€Œfiberæ¶æ„åˆ™ä¸ä¸€æ ·ã€‚åº•å±‚æ˜¯åŸºäºrequestIdleCallbackæ¥è°ƒåº¦diffç®—æ³•çš„æ‰§è¡Œï¼Œå…³äºrequestIdleCallbackçš„ä»‹ç»å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡å…³äºjsäº‹ä»¶å¾ªç¯çš„æ–‡ç« javascriptäº‹ä»¶å¾ªç¯ï¼ˆæµè§ˆå™¨ç«¯ã€nodeç«¯ï¼‰ã€‚requestIdlecallbackçš„ç‰¹ç‚¹é¡¾åæ€ä¹‰å°±æ˜¯åˆ©ç”¨ç©ºé—²æ—¶é—´æ¥å®Œæˆä»»åŠ¡ã€‚æ³¨æ„è¿™é‡Œçš„ç©ºé—²æ—¶é—´å°±æ˜¯ç›¸å¯¹äºé‚£äº›ä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡(æ¯”å¦‚ç”¨æˆ·è¾“å…¥ã€uiæ¸²æŸ“)æ¥è¯´çš„ã€‚
è¿™é‡Œå†ç®€å•ä»‹ç»ä¸€ä¸‹fiberè¿™ä¸ªåç§°çš„ç”±æ¥ï¼Œå› ä¸ºæˆ‘ä¸€å¼€å§‹å°±å¾ˆå¥½å¥‡ä¸ºä»€ä¹ˆå«åšfiberã€‚fiberå…¶å®æ˜¯çº¤ç¨‹çš„æ„æ€ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ–°è¯æ±‡ï¼Œå¤§å®¶å¯ä»¥çœ‹ç»´åŸºç™¾ç§‘çš„è§£é‡ŠFiber (computer science)ã€‚å…¶å®å°±æ˜¯æƒ³è¡¨è¾¾ä¸€ç§æ›´åŠ ç²¾ç»†ç²’åº¦çš„è°ƒåº¦çš„æ„æ€ï¼Œå› ä¸ºåŸºäºè¿™ç§ç®—æ³•reactå¯ä»¥éšæ—¶æš‚åœdiffç®—æ³•çš„æ‰§è¡Œï¼Œè€Œåæœ‰ç©ºé—²æ—¶é—´äº†æ¥ç€æ‰§è¡Œï¼Œè¿™æ˜¯ä¸€ç§æ›´åŠ ç²¾ç»†çš„è°ƒåº¦ç®—æ³•ï¼Œå› æ­¤ç§°ä¸ºfiberæ¶æ„ã€‚æœ¬ç¯‡å¯¹fiberå°±å…ˆç®€å•ä»‹ç»è¿™äº›ï¼Œåé¢æœ‰æ—¶é—´å†å•ç‹¬æ€»ç»“ä¸€ç¯‡ã€‚

### 6 å‚è€ƒèµ„æ–™
ä¸»è¦å‚è€ƒä»¥ä¸‹èµ„æ–™ï¼š

- React Components, Elements, and Instances
- Refs and the DOM
- HTMLElementä»‹ç»
- Didact: a DIY guide to build your own React
- How Does React Tell a Class from a Function?
- Lin Clark - A Cartoon Intro to Fiber - React Conf 2017
- Letâ€™s fall in love with React Fiber


è½¬è‡ª https://juejin.cn/post/6844903733998911501